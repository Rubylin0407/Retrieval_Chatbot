<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行團行程小幫手</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+P6i1EnyFp5Fm8afLRSc5AI5j6b0Piv5S9ezcLw4Pb3UrRY" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Arial', sans-serif; /* Ensuring a clear font is used */
            background-color: #fffce8;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-width:100%;
        }
    
        .box {
            width: min(95%, 1100px);
            margin: 85px auto 0;
            background-color: #f7fafc; /* Light gray background for clarity */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Soft shadow for depth */
            padding: 20px;
            overflow: hidden;
        }

    
        .bottom {
            position: fixed;
            bottom: 0;
            padding-bottom: 5%;
            background-color: #ffffff;
            width: min(95%, 800px);
        }
    
        .upper {
            max-height: 100%;
            padding-top: 40px;
            padding-bottom: 170px;
            overflow: auto;
        }
    
        .upper::-webkit-scrollbar {
            width: 0 !important
        }
    
        #sendbtn:disabled {
            opacity: 0.6;
        }
    
        .downwarning {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            font-size: 90%;
            color: gray;
        }
    
        nav {
            position: fixed;
            width: 100%;
            padding: 3px;
            background-color: #ffe5c1; /* soft, semi-transparent gray */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2); /* subtle shadow for an elevated feel */
            z-index: 2;
            backdrop-filter: blur(2px); /* adds a slight blur to the content behind the nav for depth */
        }

        /* Additional CSS for clarity and spacing */
        .nav-right {
            margin-left: auto; /* Push the content to the right edge */
            display: flex;
            align-items: center;
            gap: 15px; /* Creates a gap between elements inside */
        }

        .nav-separator {
            height: 20px;
            border-left: 1px solid #ccc; /* A soft gray vertical separator */
            margin: 0 15px; /* Spacing on both sides of the separator */
        }

        /* Update color for text to dark gray */
        a, span {
            color: #333333;
        }

        a:hover, a:focus {
            color: #555555; /* A slightly lighter gray for hover and focus states */
            text-decoration: none;
        }


        /* Hover effects for better user experience */
        a:hover, a:focus {
            color: #3182ce; /* Using the brighter blue */
            text-decoration: none;
        }

        /* Typography */
        #QA-history-table {
            font-size: 16px;
            border-radius: 15px;
            overflow: hidden;
        }

        #QA-history-table caption {
            font-size: 24px;
            margin-bottom: 16px;
            color: #4A4A4A;
        }

        /* Spacing */
        #QA-history-table th,
        #QA-history-table td {
            padding: 14px 20px;
            border: 1px solid #E2E8F0;
        }

        #QA-history-table th:first-child {
            border-top-left-radius: 15px; 
        }

        #QA-history-table th:last-child {
            border-top-right-radius: 15px; 
        }

        #QA-history-table tr:last-child td:first-child {
            border-bottom-left-radius: 15px; 
        }

        #QA-history-table tr:last-child td:last-child {
            border-bottom-right-radius: 15px; 
        }
        /* Colors */
        #QA-history-table th {
            background-color: #fff06e86;  /* Change to a different color if desired */
            color: #2d3748;  /* Deep gray color */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #QA-history-table tbody tr:hover {
            background-color: #E8F0FE; /* Light blue hover effect */
        }

        #QA-history-table tr:nth-child(odd) {
            background-color: #fafce4bd; /* Alternate row color for better readability */
        }

        /* Borders & Shadows */
        #QA-history-table {
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            overflow: hidden; /* This will ensure the table respects the border-radius of the container */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }

        #QA-history-table th, 
        #QA-history-table td {
            border-bottom: 1px solid #E2E8F0;
        }

        #QA-history-table tr:last-child td {
            border-bottom: none;
        }

        #QA-history-table th:nth-child(1), #QA-history-table td:nth-child(1) {
            width: 20%;
        }
        #QA-history-table th:nth-child(3), #QA-history-table td:nth-child(3) {
            width: 15%; 
        }

        #QA-history-table td:nth-child(3) {
            text-align: center;      /* For horizontal centering */
            vertical-align: middle;  /* For vertical centering */
        }

        .container a {
            color: #02448a;
            text-decoration: underline;
        }
        .container a:hover {
            color: rgb(105, 162, 247);
            text-decoration: none;
        }

        td {
            white-space: pre-line; /* This CSS property will respect newline characters and whitespace in content */
        }
        </style>
    </head>

<body class="bg-image">
    <nav>
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <a href="/" class="flex items-center">
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">旅行團行程小幫手</span>
            </a>

            <!-- Add the buttons to the navigation bar -->
            <div class="flex space-x-4">
                {% if session['logged_in'] %}
                <!-- Add History and Favorites buttons -->
                    <a href="/searchhistory" >歷史紀錄</a>
                    <a href="/favorites" >我的最愛</a>
        
                    <div class="nav-separator"></div> <!-- Separator for clarity -->
        
                    <!-- Container for greeting and logout -->
                    <div class="nav-right">
                        <!-- Display username when logged in -->
                        <span class="text-gray-600">Hello, {{ session['name'] }}!</span>
                        <a href="/user/logout" class="text-gray-600 hover:text-gray-800">Log out</a>
                {% else %}
                    <!-- Display login and signup links when not logged in -->
                    <a href="/user/login" class="text-gray-600 hover:text-gray-800">Log in</a>
                    <a href="/user/signup" class="text-gray-600 hover:text-gray-800">Sign up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="box">
            <!-- 歷史紀錄 table -->
            <table id="QA-history-table">
                <caption>歷史提問紀錄</caption>
                <thead>
                    <tr>
                        <th>提問</th>
                        <th>回答</th>
                        <th>加到我的最愛</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <script>
        // Call the fetchQAHistory function when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            fetchQAHistory();
        });
    
        // Function to fetch QA-history data from MongoDB and display question-answer pairs in a table
        async function fetchQAHistory() {
            try {
                const response = await fetch('/api/v1/get-qa-history');
                const user_data = await response.json();
    
                // Get a reference to the table element in your HTML
                const table = document.getElementById('QA-history-table');
    
                // Fetch the user's favorite items
                const favorites = await fetchUserFavorites(); // Implement this function
    
                // Loop through the user_data and create table rows for each question-answer pair
                user_data.forEach(entry => {
                    const question = entry.question;
                    const rawAnswer = entry.answer;

                    // Parse rawAnswer to transform URLs into clickable links
                    const linkedAnswer = rawAnswer.replace(
                        /\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g,
                        '<a href="$2" target="_blank">$1</a>'
                    );

                    const QA_pair_id = entry.id_str;

                    // Create a new table row
                    const row = table.insertRow();

                    // Create table cells for question and answers
                    const questionCell = row.insertCell(0);
                    const answerCell = row.insertCell(1);

                    // Populate the table cells with question and answers
                    questionCell.innerText = `${question}`;
                    answerCell.innerHTML = linkedAnswer; // Use innerHTML here because we're inserting HTML content
    
                    // Create a button cell and button element
                    const buttonCell = row.insertCell(2);
                    const addButton = document.createElement('button');
    
                    // Check if the current item is in the user's favorites
                    if (favorites.includes(QA_pair_id)) {
                        addButton.classList.add('favorite');
                        addButton.innerHTML = '&#10084;'; // Solid heart
                    } else {
                        addButton.innerHTML = '&#9825'; // Outline heart
                    }
    
                    addButton.addEventListener('click', () => {
                        // Handle the "Add to Favorites" action here
                        addToFavorites(QA_pair_id, addButton);
                    });
                    buttonCell.appendChild(addButton);
                });
            } catch (error) {
                console.error('Error fetching QA-history data:', error);
            }
        }

    
        // Function to fetch the user's favorite items
        async function fetchUserFavorites() {
            try {
                const response = await fetch('/api/v1/get-user-favorites');
                const favorites = await response.json();
                return favorites.map(fav => fav.QA_pair_id);
            } catch (error) {
                console.error('Error fetching user favorites:', error);
                return [];
            }
        }
    
        // Function to handle the "Add to Favorites" action
        function addToFavorites(QA_pair_id, button) {
            // Check if the button already has a class "favorite"
            if (button.classList.contains('favorite')) {
                // If it does, remove the class and change the heart to outline
                button.classList.remove('favorite');
                button.innerHTML = '&#9825'; // Change to outline heart
                // Implement your logic to remove the item from favorites here
                removeFavorite(QA_pair_id);
            } else {
                // If it doesn't have the class, add the class and change the heart to solid
                button.classList.add('favorite');
                button.innerHTML = '&#10084;'; // Change to solid heart
                // Implement your logic to add the item to favorites here
                addFavorite(QA_pair_id);
            }
        }
    
        // Function to add an item to the user's favorites
        async function addFavorite(QA_pair_id) {
            try {
                await fetch('/api/v1/add-favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({QA_pair_id })
                });
                console.log('Added to Favorites:', QA_pair_id);
            } catch (error) {
                console.error('Error adding to Favorites:', error);
            }
        }
    
        // Function to remove an item from the user's favorites
        async function removeFavorite(QA_pair_id) {
            try {
                await fetch('/api/v1/remove-favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ QA_pair_id })
                });
                console.log('Removed from Favorites:', QA_pair_id);
            } catch (error) {
                console.error('Error removing from Favorites:', error);
            }
        }
    </script>
</body>
</html>
